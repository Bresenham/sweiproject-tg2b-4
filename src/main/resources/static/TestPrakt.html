<!doctype html>
<html>

<head>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <style type="text/css">
        .sidebar {
            width: 20%;
            margin-top: 2%;
            float: right;
            font-size: 16px;
        }
    </style>
</head>

<body>
    <div class="sidebar">
        <ul class="nav nav-sidebar">
            <li><a href="#" id="defaultView">Default View</a></li>
            <li><a data-toggle="collapse" data-target="#filterContainer" href="#">Filter by</a>
                <div class="collapse" id="filterContainer">
                    <select class="form-control" id="filterType">
                        <option value="Tag">Tag</option>
                        <option value="Category">Category</option>
                    </select>
                    <input type="text" class="form-control" id="tagInput" />
                    <select class="form-control collapse" id="categorySelection"> </select>
                </div>
            </li>
            <li><a data-toggle="collapse" data-target="#groupContainer" href="#">Group by</a>
                <div class="collapse" id="groupContainer">
                    <select class="form-control" id="groupType">
                        <option value="Category">Category</option>
                    </select>
                </div>
            </li>
            <li>&nbsp;</li>
            <li>
                <button type="button" id="btnApply" class="btn btn-success form-control">Apply</button>
            </li>
            <li>&nbsp;</li>
            <li>
                <button type="button" id="btnCreatePost" class="btn btn-warning form-control">Create New Post</button>
            </li>
        </ul>
    </div>
    <div id="myDiv"></div>
    <script type="text/javascript">
        var myPlot = document.getElementById('myDiv');
        var lastActive = "";
        $(document).ready(function () {
            var cats = getCategories();
            $.each(cats, function (idx, cat) {
                $("#categorySelection").append("<option value=\"" + cat + "\">" + cat + "</option>");
            });
            display(groupByCategory(getAllPosts()), false);
        });
        $("#defaultView").click(function () {
            location.reload();
        });
        $("#groupType").click(function () {
            lastActive = "Group";
        });
        $("#filterType").click(function () {
            lastActive = "Filter";
        });
        $("#filterType").change(function () {
            var selection = $("#filterType :selected").text();
            if (selection == "Tag") {
                $("#tagInput").show();
                $("#categorySelection").hide();
            }
            else if (selection == "Category") {
                $("#categorySelection").show();
                $("#tagInput").hide();
            }
            lastActive = "Filter";
        });
        $("#btnApply").click(function () {
            if (lastActive == "Filter") {
                var selection = $("#filterType :selected").text();
                var filtered = {};
                if (selection == "Category") {
                    var cat = $("#categorySelection :selected").text();
                    filtered = filterByCategory(cat);
                }
                else if (selection == "Tag") {
                    var tags = $("#tagInput").val().split("#");
                    filtered = filterByTags(tags);
                }
                display(filtered, true);
            }
            else if (lastActive == "Group") {
                var selection = $("#groupType :selected").text();
                var filtered = {};
                if (selection == "Category") {
                    filtered = groupByCategory();
                }
                display(filtered, true);
            }
        });
        $("#btnCreatePost").click(function () {
            window.location.href = "./RequestID.html";
        });

        function display(databaseObj, grouped) {
            Plotly.purge(myDiv);
            var data = [];
            var alpha = 2;
            console.log(databaseObj);
            var globalIdx = 1;
            $.each(databaseObj, function (key, value) {
                var color = "rgb(" + Math.random() * 255 + "," + Math.random() * 255 + "," + Math.random() * 255 + ")"
                var N = databaseObj[key].length;
                var b = Math.round(alpha * Math.sqrt(N));
                var phi = (Math.sqrt(alpha) + 1) / 2;
                var rnd = Math.random();
                var fac = grouped ? 10 : 1;
                $.each(value, function (idx, obj) {
                    var i = grouped ? idx + 1 : globalIdx;
                    var r = radius(i, N, b);
                    var theta = 2 * Math.PI * i / phi ^ 2;
                    var x = r * Math.cos(theta) + rnd * fac;
                    var y = r * Math.sin(theta) + rnd * fac;
                    var tagStr = $.map(obj.tags, function (val, i) {
                        return "#" + val;
                    });
                    var object = {
                        x: [x]
                        , y: [y]
                        , type: "scatter"
                        , name: obj.category
                        , mode: "markers"
                        , marker: {
                            size: 24
                            , color: color
                        }
                        , obj: obj
                        , hovertext: obj.category + ": " + obj.title + " [" + tagStr + "]"
                        , textposition: 'bottom'
                        , hoverinfo: "text"
                    };
                    data.push(object);
                    globalIdx += 1;
                });
            });
            var layout = {
                hovermode: 'closest'
                , showlegend: false
                , autosize: false
                , width: 1400
                , height: 900
                , xaxis: {
                    autorange: true
                    , showgrid: false
                    , zeroline: false
                    , showline: false
                    , autotick: true
                    , ticks: ''
                    , showticklabels: false
                }
                , yaxis: {
                    autorange: true
                    , showgrid: false
                    , zeroline: false
                    , showline: false
                    , autotick: true
                    , ticks: ''
                    , showticklabels: false
                }
            };
            Plotly.newPlot('myDiv', data, layout, {
                displayModeBar: false
            });
            myPlot.on('plotly_click', function (data) {
                var pts = '';
                var point = null;
                for (var i = 0; i < data.points.length; i++) {
                    pts = 'x = ' + data.points[i].x + '\ny = ' + data.points[i].y.toPrecision(4) + '\n\n';
                    point = data.points[i];
                }
                console.log(point);
                alert('Closest point clicked:\n\n' + pts + "\r\nText: " + point.data.obj.text);
            });
        }

        function groupByCategory() {
            var dict = {};
            var databaseObj = getAllPosts();
            $.each(databaseObj, function (idx, obj) {
                dict[obj.category] = dict[obj.category] || [];
                dict[obj.category].push(obj);
            });
            return dict;
        }

        function groupByTag() {
            var dict = {};
            var databaseObj = getAllPosts();
            $.each(databaseObj, function (idx, obj) {
                $.each(obj.tags, function (idx, tag) {
                    dict[obj.category] = dict[obj.category] || [];
                    dict[obj.category].push(obj);
                })
            });
            return dict;
        }

        function filterByCategory(cat) {
            var grouped = groupByCategory(getAllPosts());
            var filtered = {};
            filtered[cat] = [];
            $.map(grouped, function (value, key) {
                if (key == cat) filtered[cat] = value;
            });
            return filtered;
        }

        function filterByTags(tags) {
            var databaseObj = getAllPosts();
            var filtered = {};
            $.each(tags, function (idx, tag) {
                filtered[tag] = [];
            });
            $.each(databaseObj, function (idx, obj) {
                $.each(tags, function (idx, tag) {
                    if (obj.tags.indexOf(tag) > -1) filtered[tag].push(obj);
                });
            });
            return filtered;
        }

        function radius(k, n, b) {
            var r = 0;
            if (k > (n - b)) r = 1;
            else r = Math.sqrt(k - (1 / 2)) / Math.sqrt(n - (b + 1) / 2);
            return r;
        }

        function getAllPosts() {
            return [{
                    category: "Enterpreneurship"
                    , title: "Die Geschichte meines ersten eigenen Unternehmens"
                    , tags: ["Money", "Freedom", "Rich"]
                }
                , {
                    category: "Enterpreneurship"
                    , title: "Mein erstes, eigenes Unternehmen"
                    , tags: ["Money", "Rich"]
                }
                , {
                    category: "Enterpreneurship"
                    , title: "Mein erstes, eigenes Unternehmen"
                    , tags: ["Poor", "Money"]
                }, {
                    category: "Enterpreneurship"
                    , title: "Mein erstes, eigenes Unternehmen"
                    , tags: ["Money"]
                }, {
                    category: "Teachers"
                    , title: "Mein erstes, eigenes Unternehmen"
                    , tags: ["Learn", "Teach", "Life"]
                }
                , {
                    category: "Teachers"
                    , title: "Mein erstes, eigenes Unternehmen"
                    , tags: ["Learn", "Teach"]
                }
                , {
                    category: "Teachers"
                    , title: "Mein erstes, eigenes Unternehmen"
                    , tags: []
                }, {
                    category: "Teachers"
                    , title: "Mein erstes, eigenes Unternehmen"
                    , tags: ["Life"]
                }
                , {
                    category: "Teachers"
                    , title: "Mein erstes, eigenes Unternehmen"
                    , tags: ["Smart", "Rich"]
                }
                , {
                    category: "Teachers"
                    , title: "Mein erstes, eigenes Unternehmen"
                    , tags: ["Intelligence"]
                }, {
                    category: "Teachers"
                    , title: "Mein erstes, eigenes Unternehmen"
                    , tags: []
                }
            ];
        }

        function getCategories() {
            return ["Students", "Teachers", "Travelling", "Enterpreneurship", "Business"];
        }
    </script>
</body>

</html>